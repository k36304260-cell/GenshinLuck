<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Genshin Luck Analyzer - Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0b111a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; background-image: radial-gradient(circle at 20% 30%, #1a2332 0%, #0b111a 100%); }
        .glass-card { background: rgba(26, 35, 50, 0.85); border-radius: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); }
        .nav-active { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .pull-bar-container { height: 1.25rem; background: #0f172a; border-radius: 999px; overflow: hidden; position: relative; }
        .pull-bar-fill { height: 100%; transition: width 0.8s ease-out; }
        .bar-green { background: linear-gradient(90deg, #10b981, #059669); }
        .bar-yellow { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .bar-red { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* ã€Œæ­ªã€ç´…åœˆæ¨™ç±¤æ¨£å¼ */
        .off-banner-tag {
            display: inline-flex; align-items: center; justify-content: center;
            width: 24px; height: 24px; border: 2px solid #ef4444;
            color: #ef4444; border-radius: 50%; font-size: 13px;
            font-weight: 900; margin-left: 10px; vertical-align: middle;
        }

        /* å»ºè­°æ¸…å–®æ¨£å¼ */
        .suggestion-item { padding: 10px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .suggestion-item:hover { background: rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="p-6 md:p-12 min-h-screen">
    <div class="max-w-7xl mx-auto space-y-8">
        <header class="flex flex-col md:flex-row justify-between items-center gap-6">
            <h1 class="text-4xl font-black tracking-tighter text-white italic">GENSHIN <span class="text-blue-500">LUCK</span></h1>
            <div class="flex items-center space-x-2 bg-gray-800/50 p-1 rounded-2xl border border-gray-700">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all nav-active">æ•¸æ“šåˆ†æ</button>
                <button onclick="switchTab('input')" id="btn-input" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-gray-400">æ•¸æ“šéŒ„å…¥</button>
                <div class="h-6 w-px bg-gray-700 mx-2"></div>
                <input type="text" id="userId" value="1800761135" onchange="refreshAll()" class="bg-transparent border-none text-center font-mono text-blue-400 w-36 outline-none">
            </div>
        </header>

        <main id="tab-dashboard" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <section class="lg:col-span-4 space-y-6">
                <div class="glass-card p-10 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-blue-500"></div>
                    <p class="text-gray-400 text-[10px] uppercase tracking-[0.3em] mb-4">æŠ½å¡æ­çš‡åº¦é‘‘å®š</p>
                    <h2 id="overallRank" class="text-4xl font-black bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent italic">è®€å–ä¸­...</h2>
                </div>

                <div class="glass-card p-8 space-y-5">
                    <h3 class="text-xs font-bold text-blue-400 border-l-4 border-blue-500 pl-3 uppercase tracking-widest">æŠ½å¡è©³æƒ…åˆ†æ</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-500">å°ä¿åº•ä¸æ­ªç‡</span>
                            <span id="adv-win-rate" class="font-black text-yellow-500">--%</span>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-500">ç¸½è¨ˆæŠ½æ•¸ / æ¶ˆè€—</span>
                            <div class="text-right">
                                <p id="adv-total-pulls" class="font-black text-white">-- æŠ½</p>
                                <p id="adv-total-stones" class="italic text-gray-500">-- åŸçŸ³</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-500">æœ€å¹¸é‹å¡æ± </span>
                            <span id="adv-lucky-pool" class="font-bold text-green-400">--</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-3 pt-4 border-t border-gray-800">
                        <div class="bg-gray-900/40 p-4 rounded-xl border border-gray-800/50">
                            <p class="text-[9px] text-gray-500 uppercase mb-1">å¹³å‡æ¯å€‹ UP è§’è‰²èŠ±è²»</p>
                            <p id="adv-char-stone" class="text-xl font-black text-white">-- <span class="font-black">åŸçŸ³</span></p>
                        </div>
                        <div class="bg-gray-900/40 p-4 rounded-xl border border-gray-800/50">
                            <p class="text-[9px] text-gray-500 uppercase mb-1">å¹³å‡æ¯æŠŠé™å®šæ­¦å™¨èŠ±è²»</p>
                            <p id="adv-weapon-stone" class="text-xl font-black text-white">-- <span class="font-black">åŸçŸ³</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-8 glass-card p-8 min-h-[500px] flex flex-col">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-lg font-bold flex items-center"><span class="w-1.5 h-6 bg-blue-500 rounded-full mr-3"></span>å‡ºé‡‘æ­·å²</h3>
                    <div class="flex bg-gray-900/60 rounded-xl p-1 text-xs">
                        <button onclick="togglePool('character')" id="pool-char" class="px-6 py-1.5 font-bold rounded-lg bg-gray-700 text-white transition-all">è§’è‰²æ± </button>
                        <button onclick="togglePool('weapon')" id="pool-weapon" class="px-6 py-1.5 font-bold rounded-lg text-gray-500 ml-1 transition-all">æ­¦å™¨æ± </button>
                    </div>
                </div>
                <div id="historyContainer" class="space-y-6 overflow-y-auto pr-4 no-scrollbar flex-grow"></div>
            </section>
        </main>

        <main id="tab-input" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="glass-card p-10 space-y-8">
                <h3 class="text-xl font-bold border-l-4 border-blue-500 pl-4 uppercase">æ‰‹å‹•æ–°å¢</h3>
                <div class="space-y-4 relative">
                    <select id="inputPool" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-sm outline-none">
                        <option value="character">é™å®šè§’è‰²æ± </option><option value="weapon">æ­¦å™¨ç¥ˆé¡˜æ± </option>
                    </select>
                    <input type="text" id="inputName" autocomplete="off" onkeyup="showSuggestions(this.value)" placeholder="äº”æ˜Ÿåç¨± (å¦‚ï¼šè¿ªå¸Œé›…ã€é­ˆ)" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-sm outline-none">
                    <div id="suggestions" class="absolute z-50 w-full bg-gray-800 rounded-xl mt-[-10px] hidden border border-gray-700 shadow-2xl overflow-hidden text-xs"></div>
                    
                    <input type="number" id="inputPulls" placeholder="æ¶ˆè€—æŠ½æ•¸" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-sm outline-none">
                    <button onclick="submitManual()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg transition active:scale-95">æäº¤ç´€éŒ„</button>
                </div>
            </div>

            <div class="glass-card p-8 space-y-6">
                <h3 class="text-xl font-bold border-l-4 border-green-500 pl-4 uppercase">Excel æ‰¹é‡ç®¡ç†</h3>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('fileInput').click()" class="flex-1 bg-gray-800 py-4 rounded-xl font-bold hover:bg-gray-700 transition">åŒ¯å…¥ Excel</button>
                    <button onclick="exportData()" class="flex-1 bg-gray-800 py-4 rounded-xl font-bold hover:bg-gray-700 transition">å°å‡ºå‚™ä»½</button>
                </div>
                <input type="file" id="fileInput" class="hidden" onchange="importExcel(this)">
            </div>
        </main>
    </div>

    <script>
        const API = "https://genshinluck.onrender.com";
        let currentPool = 'character';
        
        // å¸¸é§å»ºè­°æ¸…å–®
        const standardList = [
            "åˆ»æ™´", "è¿ªç›§å…‹", "ä¸ƒä¸ƒ", "ç´", "è«å¨œ", "æç´é‡Œ", "è¿ªå¸Œé›…", "å¤¢è¦‹æœˆç‘å¸Œ",
            "é˜¿è«æ–¯ä¹‹å¼“", "å¤©ç©ºä¹‹ç¿¼", "å››é¢¨åŸå…¸", "å¤©ç©ºä¹‹å·", "å’Œç’é³¶", "å¤©ç©ºä¹‹è„Š", "ç‹¼çš„æœ«è·¯", "å¤©ç©ºä¹‹å‚²", "é¢¨é·¹åŠ", "å¤©ç©ºä¹‹åˆƒ"
        ];

        window.onload = refreshAll;

        function switchTab(tab) {
            document.getElementById('tab-dashboard').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('tab-input').classList.toggle('hidden', tab !== 'input');
            document.getElementById('btn-dashboard').className = tab === 'dashboard' ? 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all nav-active' : 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-gray-400 hover:text-white';
            document.getElementById('btn-input').className = tab === 'input' ? 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all nav-active' : 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-gray-400 hover:text-white';
        }

        function togglePool(pool) {
            currentPool = pool;
            document.getElementById('pool-char').className = pool === 'character' ? 'px-6 py-1.5 font-bold rounded-lg bg-gray-700 text-white transition-all' : 'px-6 py-1.5 font-bold rounded-lg text-gray-500 ml-1 transition-all';
            document.getElementById('pool-weapon').className = pool === 'weapon' ? 'px-6 py-1.5 font-bold rounded-lg bg-gray-700 text-white transition-all' : 'px-6 py-1.5 font-bold rounded-lg text-gray-500 ml-1 transition-all';
            loadHistoryList();
        }

        // æ¨¡ç³Šå»ºè­°é‚è¼¯
        function showSuggestions(val) {
            const container = document.getElementById('suggestions');
            if (!val) { container.classList.add('hidden'); return; }
            const matches = standardList.filter(s => s.includes(val));
            if (matches.length > 0) {
                container.innerHTML = matches.map(m => `<div class="suggestion-item" onclick="selectName('${m}')">${m} <span class="text-gray-500">(å¸¸é§æç¤º)</span></div>`).join('');
                container.classList.remove('hidden');
            } else { container.classList.add('hidden'); }
        }

        function selectName(n) { document.getElementById('inputName').value = n; document.getElementById('suggestions').classList.add('hidden'); }

        async function refreshAll() {
            const userId = document.getElementById('userId').value;
            try {
                const resSum = await fetch(`${API}/get_summary?user_id=${userId}`);
                const dataSum = await resSum.json();
                document.getElementById('overallRank').innerText = dataSum.character.rank;

                const resAdv = await fetch(`${API}/get_advanced_stats?user_id=${userId}`);
                const dataAdv = await resAdv.json();
                document.getElementById('adv-win-rate').innerText = dataAdv.win_rate;
                document.getElementById('adv-total-pulls').innerText = `${dataAdv.total_pulls} æŠ½`;
                document.getElementById('adv-total-stones').innerText = `${dataAdv.total_stones} åŸçŸ³`;
                document.getElementById('adv-lucky-pool').innerText = dataAdv.lucky_pool;
                
                // åŸçŸ³æ–‡å­—å°é½Šå„ªåŒ–
                document.getElementById('adv-char-stone').innerHTML = `${dataAdv.avg_char_stone.toLocaleString()} <span class="font-black text-white">åŸçŸ³</span>`;
                document.getElementById('adv-weapon-stone').innerHTML = `${dataAdv.avg_weapon_stone.toLocaleString()} <span class="font-black text-white">åŸçŸ³</span>`;

                loadHistoryList();
            } catch (e) { console.error("API é€£ç·šå¤±æ•—"); }
        }

        async function loadHistoryList() {
            const userId = document.getElementById('userId').value;
            const res = await fetch(`${API}/get_history?user_id=${userId}`);
            const records = await res.json();
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';
            
            records.filter(r => r.pool === currentPool).forEach(r => {
                const colorClass = r.pulls <= 30 ? 'bar-green' : (r.pulls <= 60 ? 'bar-yellow' : 'bar-red');
                const width = Math.min((r.pulls / 90) * 100, 100);
                const item = document.createElement('div');
                item.className = "group relative animate-fade-in";
                
                // ã€Œæ­ªã€æ¨™ç±¤åˆ¤å®š
                const offBannerHtml = r.is_up ? '' : '<span class="off-banner-tag">æ­ª</span>';

                item.innerHTML = `
                    <div class="flex justify-between items-end mb-2 px-1">
                        <div class="flex items-center">
                            <span class="text-sm font-bold text-white mr-2">${r.name}</span>
                            ${offBannerHtml}
                            <button onclick="deleteRecord(${r.id})" class="opacity-0 group-hover:opacity-100 text-red-500 text-xs ml-3 transition-opacity duration-200">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                        <span class="text-lg font-black italic ${r.pulls <= 30 ? 'text-green-400' : 'text-gray-400'}">${r.pulls} æŠ½</span>
                    </div>
                    <div class="pull-bar-container"><div class="pull-bar-fill ${colorClass}" style="width: ${width}%"></div></div>
                `;
                container.appendChild(item);
            });
        }

        async function deleteRecord(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
            await fetch(`${API}/delete_pull/${id}`, { method: 'DELETE' });
            refreshAll();
        }

        async function submitManual() {
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('inputName').value.trim();
            const pulls = document.getElementById('inputPulls').value;
            const pool = document.getElementById('inputPool').value;
            if(!name || !pulls) return;
            await fetch(`${API}/add_pull?user_id=${userId}&name=${name}&pulls=${pulls}&pool=${pool}`, { method: 'POST' });
            refreshAll(); 
            document.getElementById('inputName').value = "";
            document.getElementById('inputPulls').value = "";
            switchTab('dashboard');
        }

        async function importExcel(input) {
            const userId = document.getElementById('userId').value;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            const res = await fetch(`${API}/import_excel?user_id=${userId}`, { method: 'POST', body: formData });
            if(res.ok) { alert("æ•¸æ“šåŒ¯å…¥å®Œæˆ"); refreshAll(); switchTab('dashboard'); }
        }

        function exportData() {
            const userId = document.getElementById('userId').value;
            window.location.href = `${API}/export_excel?user_id=${userId}`;
        }
    </script>
</body>
</html>
